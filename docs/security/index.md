# CodeGen AI ë³´ì•ˆ ê°€ì´ë“œ ì´ëŒ

> **Version**: 1.0.0
> **Last Updated**: 2026-01-31
> **Author**: ğŸ”’ Security Expert Persona
> **Status**: Production Ready

---

## ëª©ì°¨

1. [ë³´ì•ˆ ê°œìš”](#ë³´ì•ˆ-ê°œìš”)
2. [ë³´ì•ˆ ì•„í‚¤í…ì²˜](#ë³´ì•ˆ-ì•„í‚¤í…ì²˜)
3. [ì¸ì¦ ë° ì¸ê°€](#ì¸ì¦-ë°-ì¸ê°€)
4. [ë°ì´í„° ë³´í˜¸](#ë°ì´í„°-ë³´í˜¸)
5. [API ë³´ì•ˆ](#api-ë³´ì•ˆ)
6. [ê²°ì œ ë³´ì•ˆ](#ê²°ì œ-ë³´ì•ˆ)
7. [ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸](#ë³´ì•ˆ-ì²´í¬ë¦¬ìŠ¤íŠ¸)
8. [ì¸ì‹œë˜íŠ¸ ëŒ€ì‘](#ì¸ì‹œë˜íŠ¸-ëŒ€ì‘)

---

## ë³´ì•ˆ ê°œìš”

### ë³´ì•ˆ ì›ì¹™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Principles                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ›¡ï¸ Defense in Depth (ì‹¬ì¸µ ë°©ì–´)                                        â”‚
â”‚     â””â”€ ë‹¤ì¤‘ ë³´ì•ˆ ê³„ì¸µìœ¼ë¡œ ë‹¨ì¼ ì‹¤íŒ¨ ì§€ì  ì œê±°                             â”‚
â”‚                                                                         â”‚
â”‚  ğŸ” Least Privilege (ìµœì†Œ ê¶Œí•œ)                                         â”‚
â”‚     â””â”€ í•„ìš”í•œ ìµœì†Œí•œì˜ ê¶Œí•œë§Œ ë¶€ì—¬                                       â”‚
â”‚                                                                         â”‚
â”‚  ğŸ” Zero Trust (ì œë¡œ íŠ¸ëŸ¬ìŠ¤íŠ¸)                                          â”‚
â”‚     â””â”€ ëª¨ë“  ìš”ì²­ì„ ê²€ì¦, ì•”ë¬µì  ì‹ ë¢° ì—†ìŒ                                â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“ Secure by Default (ê¸°ë³¸ ë³´ì•ˆ)                                       â”‚
â”‚     â””â”€ ë³´ì•ˆ ì„¤ì •ì´ ê¸°ë³¸ê°’                                                â”‚
â”‚                                                                         â”‚
â”‚  ğŸ”„ Fail Secure (ì•ˆì „í•œ ì‹¤íŒ¨)                                           â”‚
â”‚     â””â”€ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì•ˆì „í•œ ìƒíƒœë¡œ ì „í™˜                                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ìœ„í˜‘ ëª¨ë¸

| ìœ„í˜‘ | ì‹¬ê°ë„ | ëŒ€ì‘ |
|------|--------|------|
| ì¸ì¦ ìš°íšŒ | ğŸ”´ Critical | Supabase Auth + RLS |
| SQL Injection | ğŸ”´ Critical | Parameterized Query (Supabase) |
| XSS | ğŸŸ  High | React ìë™ ì´ìŠ¤ì¼€ì´í”„ + CSP |
| CSRF | ğŸŸ  High | Double Submit Cookie íŒ¨í„´ |
| ê²°ì œ ì¡°ì‘ | ğŸ”´ Critical | ì„œë²„ ì‚¬ì´ë“œ ê¸ˆì•¡ ê²€ì¦ |
| ì •ë³´ ìœ ì¶œ | ğŸŸ  High | í™˜ê²½ ë³€ìˆ˜ ë¶„ë¦¬ + ë§ˆìŠ¤í‚¹ |
| DDoS | ğŸŸ¡ Medium | Rate Limiting + Edge Protection |

---

## ë³´ì•ˆ ì•„í‚¤í…ì²˜

### ë³´ì•ˆ ê³„ì¸µ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Security Layers                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Layer 1: Network Security                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  âœ“ HTTPS ê°•ì œ (HSTS)                                             â”‚   â”‚
â”‚  â”‚  âœ“ TLS 1.3                                                       â”‚   â”‚
â”‚  â”‚  âœ“ Vercel Edge Network (DDoS ë³´í˜¸)                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â–¼                                          â”‚
â”‚  Layer 2: Application Security                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  âœ“ CSP (Content Security Policy)                                 â”‚   â”‚
â”‚  â”‚  âœ“ CORS ì •ì±…                                                     â”‚   â”‚
â”‚  â”‚  âœ“ Rate Limiting                                                 â”‚   â”‚
â”‚  â”‚  âœ“ Input Validation (Zod)                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â–¼                                          â”‚
â”‚  Layer 3: Authentication & Authorization                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  âœ“ Supabase Auth                                                 â”‚   â”‚
â”‚  â”‚  âœ“ Session ê¸°ë°˜ ì¸ì¦                                              â”‚   â”‚
â”‚  â”‚  âœ“ CSRF í† í° (ë¯¼ê° ì•¡ì…˜)                                          â”‚   â”‚
â”‚  â”‚  âœ“ Row Level Security (RLS)                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â–¼                                          â”‚
â”‚  Layer 4: Data Security                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  âœ“ AES-256-GCM (ë¹Œë§í‚¤ ì•”í˜¸í™”)                                    â”‚   â”‚
â”‚  â”‚  âœ“ bcrypt (ë¹„ë°€ë²ˆí˜¸ í•´ì‹±)                                         â”‚   â”‚
â”‚  â”‚  âœ“ ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹                                               â”‚   â”‚
â”‚  â”‚  âœ“ í™˜ê²½ ë³€ìˆ˜ ë¶„ë¦¬                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë³´ì•ˆ í—¤ë” ì„¤ì •

```typescript
// next.config.ts
const securityHeaders = [
  {
    key: 'Strict-Transport-Security',
    value: 'max-age=31536000; includeSubDomains'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY'
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block'
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin'
  },
  {
    key: 'Content-Security-Policy',
    value: `
      default-src 'self';
      script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.tosspayments.com;
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: https:;
      font-src 'self';
      connect-src 'self' https://api.tosspayments.com https://*.supabase.co;
      frame-src 'self' https://js.tosspayments.com;
    `.replace(/\n/g, '')
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=()'
  }
];
```

---

## ì¸ì¦ ë° ì¸ê°€

### ì¸ì¦ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Authentication Flow                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. ë¡œê·¸ì¸ ìš”ì²­                                                          â”‚
â”‚     Client â”€â”€â”€â”€â”€[email, password]â”€â”€â”€â”€â”€â–¶ Supabase Auth                   â”‚
â”‚                                                                         â”‚
â”‚  2. ì¸ì¦ ì²˜ë¦¬                                                            â”‚
â”‚     Supabase Auth â”€â”€â”€â”€[ì„¸ì…˜ í† í°]â”€â”€â”€â”€â–¶ Cookie (HttpOnly, Secure)        â”‚
â”‚                                                                         â”‚
â”‚  3. í›„ì† ìš”ì²­                                                            â”‚
â”‚     Client â”€â”€â”€â”€â”€[Cookie]â”€â”€â”€â”€â”€â–¶ Middleware â”€â”€â”€â”€â”€â–¶ Server Action          â”‚
â”‚                                     â”‚                                   â”‚
â”‚                              ì„¸ì…˜ ê²€ì¦                                   â”‚
â”‚                                     â”‚                                   â”‚
â”‚                              â–¼                                          â”‚
â”‚                         RLS ì ìš©                                         â”‚
â”‚                              â”‚                                          â”‚
â”‚                              â–¼                                          â”‚
â”‚                         Data Access                                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Row Level Security (RLS)

```sql
-- ëª¨ë“  í…Œì´ë¸”ì— RLS í™œì„±í™”
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE generated_contents ENABLE ROW LEVEL SECURITY;
ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë°ì´í„°ë§Œ ì ‘ê·¼
CREATE POLICY "users_own_data" ON profiles
  FOR ALL USING (auth.uid() = id);

CREATE POLICY "users_own_contents" ON generated_contents
  FOR ALL USING (auth.uid() = user_id);

-- ê²°ì œ ì •ë³´ëŠ” ì½ê¸°ë§Œ í—ˆìš© (ìˆ˜ì •ì€ ì„œë²„ì—ì„œë§Œ)
CREATE POLICY "users_read_payments" ON payments
  FOR SELECT USING (auth.uid() = user_id);

-- Service Roleì€ ëª¨ë“  ì‘ì—… ê°€ëŠ¥
CREATE POLICY "service_role_all" ON payments
  FOR ALL USING (auth.jwt()->>'role' = 'service_role');
```

### ì„¸ì…˜ ê´€ë¦¬

| í•­ëª© | ì„¤ì • | ì´ìœ  |
|------|------|------|
| ì„¸ì…˜ ë§Œë£Œ | 7ì¼ | ì‚¬ìš©ì í¸ì˜ì„±ê³¼ ë³´ì•ˆ ê· í˜• |
| Refresh Token | 30ì¼ | ì¥ê¸° ë¡œê·¸ì¸ ì§€ì› |
| HttpOnly | âœ… | XSS ë°©ì§€ |
| Secure | âœ… (prod) | HTTPSì—ì„œë§Œ ì „ì†¡ |
| SameSite | Lax | CSRF ë°©ì§€ |

---

## ë°ì´í„° ë³´í˜¸

### ì•”í˜¸í™” ì „ëµ

| ë°ì´í„° | ì•”í˜¸í™” ë°©ì‹ | í‚¤ ê´€ë¦¬ |
|--------|-----------|--------|
| ë¹„ë°€ë²ˆí˜¸ | bcrypt (cost 12) | ë‹¨ë°©í–¥ |
| ë¹Œë§í‚¤ | AES-256-GCM | í™˜ê²½ ë³€ìˆ˜ |
| ì„¸ì…˜ í† í° | Supabase ê´€ë¦¬ | Supabase |
| CSRF í† í° | HMAC-SHA256 | íŒŒìƒ í‚¤ |

### ë¹Œë§í‚¤ ì•”í˜¸í™”

```typescript
// src/lib/payment/crypto.ts

import { createCipheriv, createDecipheriv, randomBytes } from 'crypto';

const ALGORITHM = 'aes-256-gcm';
const IV_LENGTH = 12;
const AUTH_TAG_LENGTH = 16;

export function encryptBillingKey(billingKey: string): string {
  const key = getEncryptionKey();
  const iv = randomBytes(IV_LENGTH);

  const cipher = createCipheriv(ALGORITHM, key, iv);
  let encrypted = cipher.update(billingKey, 'utf8', 'hex');
  encrypted += cipher.final('hex');

  const authTag = cipher.getAuthTag();

  // í˜•ì‹: IV:AuthTag:EncryptedData
  return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`;
}

export function decryptBillingKey(encryptedData: string): string {
  const key = getEncryptionKey();
  const [ivHex, authTagHex, encrypted] = encryptedData.split(':');

  const iv = Buffer.from(ivHex, 'hex');
  const authTag = Buffer.from(authTagHex, 'hex');

  const decipher = createDecipheriv(ALGORITHM, key, iv);
  decipher.setAuthTag(authTag);

  let decrypted = decipher.update(encrypted, 'hex', 'utf8');
  decrypted += decipher.final('utf8');

  return decrypted;
}
```

### ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹

```typescript
// src/lib/logger.ts

const SENSITIVE_FIELDS = [
  'password',
  'secret',
  'token',
  'apiKey',
  'billingKey',
  'encryptedBillingKey',
  'cardNumber',
  'cvv',
  'customerKey',
  'paymentKey',
  'authKey',
  'authorization',
];

export function maskSensitiveData(data: unknown): unknown {
  if (typeof data !== 'object' || data === null) {
    return data;
  }

  const masked = Array.isArray(data) ? [...data] : { ...data };

  for (const key in masked) {
    if (SENSITIVE_FIELDS.some(field =>
      key.toLowerCase().includes(field.toLowerCase())
    )) {
      masked[key] = '[REDACTED]';
    } else if (typeof masked[key] === 'object') {
      masked[key] = maskSensitiveData(masked[key]);
    }
  }

  return masked;
}
```

---

## API ë³´ì•ˆ

### Rate Limiting

| ì—”ë“œí¬ì¸íŠ¸ | ì œí•œ | ì‹ë³„ì |
|-----------|------|--------|
| ë¡œê·¸ì¸ | 5/ë¶„ | IP |
| íšŒì›ê°€ì… | 3/ë¶„ | IP |
| ê²°ì œ ì¤€ë¹„ | 10/ë¶„ | ì‚¬ìš©ì ID |
| ê²°ì œ í™•ì¸ | 5/ë¶„ | ì‚¬ìš©ì ID |
| AI ìƒì„± | 20/ë¶„ | ì‚¬ìš©ì ID |
| ì¼ë°˜ ì¡°íšŒ | 30/ë¶„ | IP |

â†’ ìƒì„¸: [rate-limiting.md](./rate-limiting.md)

### CSRF ë³´í˜¸

| ì•¡ì…˜ | CSRF í•„ìˆ˜ | ìœ„í—˜ë„ |
|------|----------|--------|
| changePassword | âœ… | Critical |
| deleteAccount | âœ… | Critical |
| deleteTeam | âœ… | Critical |
| createApiKey | âœ… | High |
| deleteApiKey | âœ… | High |

â†’ ìƒì„¸: [csrf-protection.md](./csrf-protection.md)

### Input Validation

```typescript
// Zod ìŠ¤í‚¤ë§ˆë¥¼ ì‚¬ìš©í•œ ì…ë ¥ ê²€ì¦
import { z } from 'zod';

const PaymentSchema = z.object({
  paymentKey: z.string().min(1).max(200),
  orderId: z.string().regex(/^(CREDIT|SUB)_\d{8}_[A-Z0-9]+$/),
  amount: z.number().int().positive().max(10000000),
});

// Server Actionì—ì„œ ê²€ì¦
export async function confirmPayment(input: unknown) {
  const validated = PaymentSchema.safeParse(input);

  if (!validated.success) {
    return { success: false, error: 'ì…ë ¥ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤' };
  }

  // ê²€ì¦ëœ ë°ì´í„° ì‚¬ìš©
  const { paymentKey, orderId, amount } = validated.data;
  // ...
}
```

---

## ê²°ì œ ë³´ì•ˆ

### ê¸ˆì•¡ ê²€ì¦ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Payment Amount Verification                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  âŒ ìœ„í—˜: í´ë¼ì´ì–¸íŠ¸ ê¸ˆì•¡ë§Œ ì‹ ë¢°                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Client â”€[amount: 100ì›]â”€â–¶ Server â”€[ê²°ì œ ìŠ¹ì¸]â”€â–¶ ì†ì‹¤ ë°œìƒ        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  âœ… ì•ˆì „: ì„œë²„ ì‚¬ì´ë“œ ê¸ˆì•¡ ê²€ì¦                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. preparePayment: ì„œë²„ì—ì„œ ê¸ˆì•¡ ê²°ì • â†’ DB ì €ì¥                   â”‚   â”‚
â”‚  â”‚  2. í´ë¼ì´ì–¸íŠ¸: ê²°ì œ ì§„í–‰ (TossPayments)                           â”‚   â”‚
â”‚  â”‚  3. confirmPayment: DB ê¸ˆì•¡ vs í´ë¼ì´ì–¸íŠ¸ ê¸ˆì•¡ ê²€ì¦                â”‚   â”‚
â”‚  â”‚     â””â”€ ë¶ˆì¼ì¹˜ ì‹œ ê²°ì œ ê±°ë¶€                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì›¹í›… ë³´ì•ˆ

```typescript
// src/app/api/webhooks/toss/route.ts

export async function POST(request: Request) {
  const rawBody = await request.text();
  const signature = request.headers.get('X-Toss-Signature');

  // 1. ì„œëª… ê²€ì¦
  const isValid = verifyWebhookSignature(rawBody, signature);
  if (!isValid) {
    logWarn('ì›¹í›… ì„œëª… ê²€ì¦ ì‹¤íŒ¨', { signature });
    return new Response('Invalid signature', { status: 401 });
  }

  // 2. ë©±ë“±ì„± ì²˜ë¦¬
  const payload = JSON.parse(rawBody);
  const idempotencyKey = `${payload.eventType}_${payload.data.paymentKey}`;

  const { data: existing } = await supabase
    .from('webhook_logs')
    .select('id')
    .eq('idempotency_key', idempotencyKey)
    .single();

  if (existing) {
    return new Response('Already processed', { status: 200 });
  }

  // 3. ì›ìì  ì²˜ë¦¬
  await supabase.rpc('process_webhook_atomic', {
    p_idempotency_key: idempotencyKey,
    p_payload: payload,
  });

  return new Response('OK', { status: 200 });
}
```

â†’ ìƒì„¸: [../api/payment-security.md](../api/payment-security.md)

---

## ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

```yaml
ì¸ì¦:
  - [ ] HTTPS ê°•ì œ (HSTS í—¤ë”)
  - [ ] ì„¸ì…˜ ì¿ í‚¤ HttpOnly, Secure, SameSite
  - [ ] ë¡œê·¸ì¸ Rate Limiting
  - [ ] ë¹„ë°€ë²ˆí˜¸ ë³µì¡ë„ ê²€ì¦

ì¸ê°€:
  - [ ] ëª¨ë“  í…Œì´ë¸” RLS í™œì„±í™”
  - [ ] Server Actions ì¸ì¦ ì²´í¬
  - [ ] ë¯¼ê° ì•¡ì…˜ CSRF ë³´í˜¸

ë°ì´í„°:
  - [ ] ë¹Œë§í‚¤ AES-256 ì•”í˜¸í™”
  - [ ] í™˜ê²½ ë³€ìˆ˜ ì„œë²„ ì „ìš© ë¶„ë¦¬
  - [ ] ë¡œê·¸ ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹
  - [ ] ì—ëŸ¬ ë©”ì‹œì§€ì— ë‚´ë¶€ ì •ë³´ ë¯¸í¬í•¨

API:
  - [ ] ì…ë ¥ê°’ Zod ê²€ì¦
  - [ ] Rate Limiting ì ìš©
  - [ ] ì—ëŸ¬ ì‘ë‹µ í‘œì¤€í™”

ê²°ì œ:
  - [ ] ê¸ˆì•¡ ì„œë²„ ì‚¬ì´ë“œ ê²€ì¦
  - [ ] ì›¹í›… ì„œëª… ê²€ì¦
  - [ ] ë©±ë“±ì„± í‚¤ ì²˜ë¦¬
  - [ ] ì‹œí¬ë¦¿ í‚¤ í™˜ê²½ ë³€ìˆ˜

í—¤ë”:
  - [ ] Content-Security-Policy
  - [ ] X-Content-Type-Options
  - [ ] X-Frame-Options
  - [ ] Referrer-Policy
```

### OWASP Top 10 ëŒ€ì‘ í˜„í™©

| ì·¨ì•½ì  | ìƒíƒœ | ëŒ€ì‘ |
|--------|------|------|
| A01: Broken Access Control | âœ… | RLS, Server Action ì¸ì¦ |
| A02: Cryptographic Failures | âœ… | AES-256, HTTPS |
| A03: Injection | âœ… | Parameterized Query |
| A04: Insecure Design | âš ï¸ | ì§€ì†ì  ê²€í†  í•„ìš” |
| A05: Security Misconfiguration | âœ… | ë³´ì•ˆ í—¤ë”, í™˜ê²½ ë¶„ë¦¬ |
| A06: Vulnerable Components | âš ï¸ | ì •ê¸° ì—…ë°ì´íŠ¸ í•„ìš” |
| A07: Auth Failures | âœ… | Supabase Auth |
| A08: Data Integrity | âœ… | ì„œëª… ê²€ì¦, ê¸ˆì•¡ ê²€ì¦ |
| A09: Logging Failures | âœ… | êµ¬ì¡°í™”ëœ ë¡œê¹… |
| A10: SSRF | âœ… | ì™¸ë¶€ URL í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ |

---

## ì¸ì‹œë˜íŠ¸ ëŒ€ì‘

### ë³´ì•ˆ ì¸ì‹œë˜íŠ¸ ë¶„ë¥˜

| ë“±ê¸‰ | ì„¤ëª… | ëŒ€ì‘ ì‹œê°„ | ì˜ˆì‹œ |
|------|------|----------|------|
| P1 | Critical | ì¦‰ì‹œ | ë°ì´í„° ìœ ì¶œ, ê²°ì œ ì¡°ì‘ |
| P2 | High | 4ì‹œê°„ | ì¸ì¦ ìš°íšŒ ì‹œë„, DDoS |
| P3 | Medium | 24ì‹œê°„ | ë¹„ì •ìƒ ì ‘ê·¼ íŒ¨í„´ |
| P4 | Low | 72ì‹œê°„ | ë‹¨ìˆœ ìŠ¤ìº” ì‹œë„ |

### ëŒ€ì‘ ì ˆì°¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Incident Response Flow                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. íƒì§€ (Detection)                                                    â”‚
â”‚     â”œâ”€ ë¡œê·¸ ëª¨ë‹ˆí„°ë§                                                     â”‚
â”‚     â”œâ”€ ì•Œë¦¼ ìˆ˜ì‹                                                          â”‚
â”‚     â””â”€ ì‚¬ìš©ì ì‹ ê³                                                        â”‚
â”‚              â”‚                                                          â”‚
â”‚              â–¼                                                          â”‚
â”‚  2. ë¶„ë¥˜ (Triage)                                                       â”‚
â”‚     â”œâ”€ ì‹¬ê°ë„ í‰ê°€ (P1-P4)                                               â”‚
â”‚     â”œâ”€ ì˜í–¥ ë²”ìœ„ íŒŒì•…                                                    â”‚
â”‚     â””â”€ ë‹´ë‹¹ì ì§€ì •                                                       â”‚
â”‚              â”‚                                                          â”‚
â”‚              â–¼                                                          â”‚
â”‚  3. ê²©ë¦¬ (Containment)                                                  â”‚
â”‚     â”œâ”€ ì˜í–¥ë°›ì€ ê³„ì • ë¹„í™œì„±í™”                                            â”‚
â”‚     â”œâ”€ ë¬¸ì œ ì—”ë“œí¬ì¸íŠ¸ ì°¨ë‹¨                                              â”‚
â”‚     â””â”€ ì¶”ê°€ í”¼í•´ ë°©ì§€                                                    â”‚
â”‚              â”‚                                                          â”‚
â”‚              â–¼                                                          â”‚
â”‚  4. ì¡°ì‚¬ (Investigation)                                                â”‚
â”‚     â”œâ”€ ë¡œê·¸ ë¶„ì„                                                         â”‚
â”‚     â”œâ”€ ê³µê²© ë²¡í„° íŒŒì•…                                                    â”‚
â”‚     â””â”€ ì˜í–¥ ë²”ìœ„ í™•ì •                                                    â”‚
â”‚              â”‚                                                          â”‚
â”‚              â–¼                                                          â”‚
â”‚  5. ë³µêµ¬ (Recovery)                                                     â”‚
â”‚     â”œâ”€ ì·¨ì•½ì  íŒ¨ì¹˜                                                       â”‚
â”‚     â”œâ”€ ì„œë¹„ìŠ¤ ë³µêµ¬                                                       â”‚
â”‚     â””â”€ ëª¨ë‹ˆí„°ë§ ê°•í™”                                                     â”‚
â”‚              â”‚                                                          â”‚
â”‚              â–¼                                                          â”‚
â”‚  6. ì‚¬í›„ ë¶„ì„ (Post-mortem)                                             â”‚
â”‚     â”œâ”€ ê·¼ë³¸ ì›ì¸ ë¶„ì„                                                    â”‚
â”‚     â”œâ”€ ì¬ë°œ ë°©ì§€ ëŒ€ì±…                                                    â”‚
â”‚     â””â”€ ë¬¸ì„œí™”                                                            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë¹„ìƒ ì—°ë½ë§

| ì—­í•  | ë‹´ë‹¹ | ì—°ë½ì²˜ |
|------|------|--------|
| ë³´ì•ˆ ë‹´ë‹¹ | - | security@codegen.ai |
| ê°œë°œ ë¦¬ë“œ | - | dev@codegen.ai |
| ìš´ì˜ ë‹´ë‹¹ | - | ops@codegen.ai |

---

## ê´€ë ¨ ë¬¸ì„œ

- [CSRF ë³´í˜¸ ê°€ì´ë“œ](./csrf-protection.md)
- [Rate Limiting ê°€ì´ë“œ](./rate-limiting.md)
- [ê²°ì œ ë³´ì•ˆ API](../api/payment-security.md)
- [í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬](../deployment.md#í™˜ê²½-ë³€ìˆ˜-ì„¤ì •)

---

## ì°¸ê³  ìë£Œ

- [OWASP Top 10](https://owasp.org/Top10/)
- [OWASP ASVS](https://owasp.org/www-project-application-security-verification-standard/)
- [CWE Top 25](https://cwe.mitre.org/top25/)
- [Supabase Security](https://supabase.com/docs/guides/platform/security)
- [Next.js Security](https://nextjs.org/docs/app/building-your-application/authentication)

---

*ì´ ë¬¸ì„œëŠ” ë³´ì•ˆ ìœ„í˜‘ ë³€í™”ì— ë”°ë¼ ì§€ì†ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*
